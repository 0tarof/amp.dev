{% if preview.experimental %}
{% set experimental_toggle %}
  {# Get list of components to pass to the experimental toggle #}
  {% set component_list = [] %}
  {% for component in preview.imports %}
    {% do component_list.append(component.name) %}
  {% endfor %}

<button type="button" name="button" class="ap-o-code-preview-controls-button ap-o-code-preview-controls-button-experimental" on="tap:AMP.setState({showExperimentToggle{{ preview.index }}: !showExperimentToggle{{ preview.index }}})">
  <div class="ap-a-ico ap-o-code-preview-controls-icon ap-o-code-preview-controls-icon-experimental">
    <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#experimental"></use></svg>
  </div>
</button>
<div id="ap-m-experiments-preview-container-{{ preview.index }}" class="ap-m-experiments-preview-container" hidden [hidden]="!showExperimentToggle{{ preview.index }}">

  {# Render widget to toggle experiments if there are any #}
  {% if preview.experimental and preview.mode != 'inline' %}
  {% do doc.amp_dependencies.add('amp-iframe', '0.1') %}
  <h4>Experimental</h4>
  <p>{{ _('This example uses the following experimental features:') }} {% for experiment in component_list %}<code>{{ experiment }}</code>{{ ', ' if not loop.last }}{% endfor %}. {{ _('Enable the experiment via the button below. Some components require the AMP Dev Channel to be enabled as well.') }} Learn more about <a href="{{ g.doc('/content/amp-dev/documentation/guides-and-tutorials/learn/experimental.md', locale=doc.locale).url.path }}">experimental features</a>.</p>
  <amp-iframe layout="fixed-height"
              height="102"
              sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation allow-top-navigation"
              allowfullscreen
              allowpaymentrequest
              frameborder="0"
              src="{{ podspec.base_urls.preview }}/shared/experiments/?experiments={{ component_list|map('lower')|join(', ') }}&style=preview">
    <div placeholder=""></div>
  </amp-iframe>
  {% elif preview.experimental and preview.mode == 'inline' %}
  <script>const experiments = {{ component_list|tojson }}</script>
  {% do doc.styles.addCssFile('/css/components/molecules/experiments.css', 100) %}
  <div class="ap-m-experiments ap-m-experiments-preview">
    <h4>Experimental</h4>
    <p>{{ _('This example uses the following experimental features:') }} {% for experiment in component_list %}<code>{{ experiment }}</code>{{ ', ' if not loop.last }}{% endfor %}. {{ _('Enable the experiment via the button below. Some components require the AMP Dev Channel to be enabled as well.') }} Learn more about <a href="{{ g.doc('/content/amp-dev/documentation/guides-and-tutorials/learn/experimental.md', locale=doc.locale).url.path }}">experimental features</a>.</p>
    {% include '/views/partials/experiments/experiments-controls.j2' %}
  </div>
  {% include '/views/partials/experiments/experiments-script.j2' %}
  {% endif %}
</div>
{% endset %}
{% endif %}

{% if preview.mode != 'none' %}
<div class="ap-o-code-preview {{ preview.mode if preview.mode != 'none' }}">
{% endif %}

  {% if preview.mode == 'inline' %}
  {{ experimental_toggle }}
  <div class="ap-o-code-preview-preview">
     {{preview.source|render|safe}}
  </div>
  {% endif %}

  {% if preview.mode == 'top-frame' %}
  {% set initial_orientation = preview.orientation if preview.orientation else 'landscape' %}
  {% set is_landscape = True if initial_orientation == 'landscape' else False %}
  <amp-state id="orientation{{ preview.index }}">
    <script type="application/json">
      {{ is_landscape|lower }}
    </script>
  </amp-state>
  <amp-state id="example{{ preview.index }}">
    <script type="application/json">
      "{{ preview.url }}"
    </script>
  </amp-state>

  <div class="ap-o-code-preview-top-preview ap-o-code-preview-top-preview-{{ preview.index }}">
    {{ experimental_toggle }}

    <div class="ap-o-code-preview-controls">
      <button {{ 'hidden' if not is_landscape }} [hidden]="!orientation{{ preview.index }}"
              class="ap-o-code-preview-controls-button"
              on="tap:
                  AMP.setState({orientation{{ preview.index }}: false}),
                  iframeContainer{{ preview.index }}.toggleClass(class='ap-o-code-preview-preview-iframe-landscape'),
                  iframeContainer{{ preview.index }}.toggleClass(class='ap-o-code-preview-preview-iframe-portrait'),
                  bgContainer{{ preview.index }}.toggleClass(class='initial-{{ initial_orientation }}', force=false)">
        <div class="ap-a-ico ap-o-code-preview-controls-icon">
          <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#orientation-toggle"></use></svg>
        </div>
      </button>
      <button {{ 'hidden' if is_landscape }} [hidden]="orientation{{ preview.index }}"
              class="ap-o-code-preview-controls-button"
              on="tap:
                  AMP.setState({orientation{{ preview.index }}: true}),
                  iframeContainer{{ preview.index }}.toggleClass(class='ap-o-code-preview-preview-iframe-portrait'),
                  iframeContainer{{ preview.index }}.toggleClass(class='ap-o-code-preview-preview-iframe-landscape'),
                  bgContainer{{ preview.index }}.toggleClass(class='initial-{{ initial_orientation }}', force=false)">
        <div class="ap-a-ico ap-o-code-preview-controls-icon">
          <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#orientation-toggle"></use></svg>
        </div>
      </button>

      <button class="ap-o-code-preview-controls-button"
              on="tap:AMP.setState({'example{{ preview.index }}': '{{ preview.url + '?' }}' + random()})">
        <div class="ap-a-ico ap-o-code-preview-controls-icon">
          <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#reload"></use></svg>
        </div>
      </button>
    </div>

    <div id="iframeContainer{{ preview.index }}" class="ap-o-code-preview-preview-iframe ap-o-code-preview-preview-iframe-{{ initial_orientation }}">
      <amp-iframe class="ap-o-code-preview-iframe"
                  src="{{ preview.url }}"
                  [src]="example{{ preview.index }}"
                  layout="flex-item"
                  sandbox="allow-scripts allow-popups allow-same-origin"
                  frameborder="0">
        <div placeholder></div>
      </amp-iframe>
      <div id="bgContainer{{ preview.index }}" class="ap-o-code-preview-preview-iframe-background initial-{{ initial_orientation }}"></div>
    </div>
  </div>
  {% endif %}

{{content|safe}}

  {% if preview.mode == 'side-frame' %}
  <amp-state id="orientation{{ preview.index }}">
    <script type="application/json">
      "portrait"
    </script>
  </amp-state>
  <amp-state id="example{{ preview.index }}">
    <script type="application/json">
      "{{ preview.url }}"
    </script>
  </amp-state>
  {% set base_class = 'ap-o-code-preview-side-preview' %}
  <div class="{{base_class}}"
       [class]="hidePreview{{ preview.index }} != 1 ? '{{base_class}} {{base_class}}-active' : '{{base_class}}'">

    {{ experimental_toggle }}

    <button class="ap-a-fab ap-a-fab-show"
            [class]="hidePreview{{ preview.index }} != 1 ? 'ap-a-fab ap-a-fab-hide' : 'ap-a-fab ap-a-fab-show'"
            on="tap:AMP.setState({ hidePreview{{ preview.index }}: 0 }),previewIframe{{ preview.index }}.toggleClass(class='show')"
    >&#x25B6&#xFE0E;</button>
    <button class="ap-a-fab ap-a-fab-hide"
            [class]="hidePreview{{ preview.index }} == 1 ? 'ap-a-fab ap-a-fab-hide' : 'ap-a-fab ap-a-fab-show'"
            on="tap:AMP.setState({ hidePreview{{ preview.index }}: 1 }),previewIframe{{ preview.index }}.toggleClass(class='show')"
    >&#x2715&#xFE0E;</button>

    <div class="ap-m-orientation-toggle">
      {% set orientations = ['portrait', 'landscape'] %}

      {% for orientation in orientations %}
      {% do doc.icons.useIcon('/icons/orientation-' + orientation + '.svg') %}
      <button class="ap-m-orientation-toggle-button {% if orientation == 'portrait' %}active{% endif %}"
              [class]="orientation{{ preview.index }} == '{{ orientation }}' ? 'ap-m-orientation-toggle-button active' : 'ap-m-orientation-toggle-button'"
              on="tap:AMP.setState({orientation{{ preview.index }}: '{{ orientation }}'})">
        <svg class="ap-a-ico ap-m-orientation-toggle-icon">
          <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#orientation-{{ orientation }}"></use>
        </svg>
      </button>
      {% endfor %}
    </div>

    <button class="ap-o-code-preview-reload" on="tap:AMP.setState({'example{{ preview.index }}': '{{ preview.url + '?' }}' + random()})">
      <div class="ap-a-ico">
        <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#reload"></use></svg>
      </div>
    </button>

    <div id="previewIframe{{ preview.index }}"
         class="ap-o-code-preview-side-preview-frame ap-o-code-preview-side-preview-frame-portrait"
         [class]="'ap-o-code-preview-side-preview-frame ap-o-code-preview-side-preview-frame-' + orientation{{ preview.index }}">
      <div class="ap-o-code-preview-side-preview-sizer"></div>
      <amp-iframe layout="fill"
                  sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation allow-top-navigation"
                  allowfullscreen allowpaymentrequest frameborder="0"
                  src="{{ preview.url }}"
                  [src]="example{{ preview.index }}"
                  class="i-amphtml-layout-fill i-amphtml-layout-size-defined" i-amphtml-layout="fill">
        <div placeholder></div>
      </amp-iframe>
    </div>
  </div>

  {% endif %}

{% if preview.mode != 'none' %}
</div>
{% endif %}

{% if preview.playground %}
<a href="{{podspec.base_urls.playground}}/?url={{preview.url|urlencode}}%3Fformat%3D[= format =]" class="ap-m-lnk ap--playground-link">
  <div class="ap-a-ico ap-m-lnk-icon">
    <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#internal"></use></svg>
  </div>
  <span class="ap-m-lnk-text">{{_('Open this snippet in playground')}}</span>
</a>
{% endif %}
